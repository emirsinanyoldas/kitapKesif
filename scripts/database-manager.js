/**
 * Interactive Database Manager
 * 
 * A menu-driven tool to manage all database operations without remembering commands.
 * This is your one-stop tool for all database tasks.
 * 
 * Run: npm run db-manager
 */

import { createClient } from '@supabase/supabase-js';
import dotenv from 'dotenv';
import { spawn } from 'child_process';
import readline from 'readline';

// Load environment variables
dotenv.config();

const supabaseUrl = process.env.VITE_SUPABASE_URL;
const supabaseKey = process.env.VITE_SUPABASE_ANON_KEY;

if (!supabaseUrl || !supabaseKey) {
  console.error('‚ùå Error: Missing Supabase credentials in .env file');
  process.exit(1);
}

const supabase = createClient(supabaseUrl, supabaseKey);

// Create readline interface for user input
const rl = readline.createInterface({
  input: process.stdin,
  output: process.stdout
});

function question(query) {
  return new Promise(resolve => rl.question(query, resolve));
}

function clearScreen() {
  console.clear();
}

function showHeader() {
  console.log('‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó');
  console.log('‚ïë         üìä KitapKe≈üif Database Manager v1.0               ‚ïë');
  console.log('‚ïë         Your SQL Database Specialist                      ‚ïë');
  console.log('‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù');
  console.log();
}

function showMainMenu() {
  console.log('‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê');
  console.log('‚îÇ                       MAIN MENU                            ‚îÇ');
  console.log('‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§');
  console.log('‚îÇ                                                            ‚îÇ');
  console.log('‚îÇ  1. üè• Check Database Health                              ‚îÇ');
  console.log('‚îÇ  2. üîß Fix Database Permissions (First Time Setup)        ‚îÇ');
  console.log('‚îÇ  3. üìö Import Books from Open Library                     ‚îÇ');
  console.log('‚îÇ  4. üí¨ Add Sample Reviews                                 ‚îÇ');
  console.log('‚îÇ  5. üíæ Backup Database                                    ‚îÇ');
  console.log('‚îÇ  6. ‚ôªÔ∏è  Restore from Backup                               ‚îÇ');
  console.log('‚îÇ  7. üìä View Database Statistics                           ‚îÇ');
  console.log('‚îÇ  8. üîç Search Books                                       ‚îÇ');
  console.log('‚îÇ  9. üìñ Quick Reference Guides                             ‚îÇ');
  console.log('‚îÇ  0. üö™ Exit                                               ‚îÇ');
  console.log('‚îÇ                                                            ‚îÇ');
  console.log('‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò');
  console.log();
}

async function runCommand(command, args = []) {
  return new Promise((resolve, reject) => {
    const child = spawn('npm', ['run', command, '--', ...args], {
      shell: true,
      stdio: 'inherit'
    });

    child.on('close', (code) => {
      if (code === 0) {
        resolve();
      } else {
        reject(new Error(`Command failed with code ${code}`));
      }
    });
  });
}

async function checkHealth() {
  clearScreen();
  showHeader();
  console.log('Running health check...\n');
  
  try {
    await runCommand('check-db');
    console.log('\n‚úÖ Health check complete!');
  } catch (error) {
    console.log('\n‚ùå Health check failed:', error.message);
  }
  
  await question('\nPress Enter to continue...');
}

async function fixPermissions() {
  clearScreen();
  showHeader();
  console.log('‚ö†Ô∏è  Database Permission Fix\n');
  console.log('This will enable INSERT and UPDATE operations on your database.');
  console.log('This is required before importing books.\n');
  
  const confirm = await question('Continue? (y/n): ');
  
  if (confirm.toLowerCase() === 'y') {
    console.log('\nFixing permissions...\n');
    try {
      await runCommand('fix-db');
      console.log('\n‚úÖ Permissions fixed!');
    } catch (error) {
      console.log('\n‚ö†Ô∏è  Automated fix failed.');
      console.log('Please run FIX_DATABASE_NOW.sql manually in Supabase SQL Editor.');
    }
  }
  
  await question('\nPress Enter to continue...');
}

async function importBooks() {
  clearScreen();
  showHeader();
  console.log('üìö Import Books from Open Library\n');
  console.log('This will import 150+ books across 25+ diverse topics.');
  console.log('Estimated time: 2-3 minutes\n');
  
  const confirm = await question('Start import? (y/n): ');
  
  if (confirm.toLowerCase() === 'y') {
    console.log('\nImporting books...\n');
    try {
      await runCommand('import-books');
      console.log('\n‚úÖ Books imported successfully!');
    } catch (error) {
      console.log('\n‚ùå Import failed:', error.message);
      console.log('Make sure you ran "Fix Database Permissions" first!');
    }
  }
  
  await question('\nPress Enter to continue...');
}

async function addReviews() {
  clearScreen();
  showHeader();
  console.log('üí¨ Add Sample Reviews\n');
  console.log('This will add realistic reviews to all books in the database.\n');
  
  const confirm = await question('Add reviews? (y/n): ');
  
  if (confirm.toLowerCase() === 'y') {
    console.log('\nAdding reviews...\n');
    try {
      await runCommand('add-reviews');
      console.log('\n‚úÖ Reviews added successfully!');
    } catch (error) {
      console.log('\n‚ùå Adding reviews failed:', error.message);
    }
  }
  
  await question('\nPress Enter to continue...');
}

async function backupDatabase() {
  clearScreen();
  showHeader();
  console.log('üíæ Backup Database\n');
  console.log('This will create a JSON backup of all books and reviews.\n');
  
  const confirm = await question('Create backup? (y/n): ');
  
  if (confirm.toLowerCase() === 'y') {
    console.log('\nCreating backup...\n');
    try {
      await runCommand('backup-db');
      console.log('\n‚úÖ Backup created successfully!');
    } catch (error) {
      console.log('\n‚ùå Backup failed:', error.message);
    }
  }
  
  await question('\nPress Enter to continue...');
}

async function restoreDatabase() {
  clearScreen();
  showHeader();
  console.log('‚ôªÔ∏è  Restore from Backup\n');
  
  try {
    await runCommand('restore-db');
  } catch (error) {
    console.log('No backups available or selection cancelled.');
  }
  
  await question('\nPress Enter to continue...');
}

async function viewStatistics() {
  clearScreen();
  showHeader();
  console.log('üìä Database Statistics\n');
  
  try {
    // Get counts
    const { count: bookCount } = await supabase
      .from('books')
      .select('*', { count: 'exact', head: true });
    
    const { count: reviewCount } = await supabase
      .from('reviews')
      .select('*', { count: 'exact', head: true });
    
    console.log('‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê');
    console.log('‚îÇ                 QUICK STATS                    ‚îÇ');
    console.log('‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§');
    console.log(`‚îÇ  üìö Total Books:      ${String(bookCount).padEnd(24)}‚îÇ`);
    console.log(`‚îÇ  üí¨ Total Reviews:    ${String(reviewCount).padEnd(24)}‚îÇ`);
    console.log(`‚îÇ  üìñ Avg Reviews/Book: ${String((reviewCount / bookCount).toFixed(1)).padEnd(24)}‚îÇ`);
    console.log('‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò');
    console.log();
    
    // Get top books
    const { data: topBooks } = await supabase
      .from('books')
      .select('title, author, average_rating, total_reviews')
      .order('average_rating', { ascending: false })
      .limit(5);
    
    if (topBooks && topBooks.length > 0) {
      console.log('üèÜ Top Rated Books:');
      topBooks.forEach((book, index) => {
        console.log(`   ${index + 1}. "${book.title}" by ${book.author}`);
        console.log(`      ‚≠ê ${book.average_rating} (${book.total_reviews} reviews)`);
      });
      console.log();
    }
    
    // Get category distribution
    const { data: books } = await supabase
      .from('books')
      .select('category');
    
    if (books && books.length > 0) {
      const categories = books.reduce((acc, book) => {
        acc[book.category] = (acc[book.category] || 0) + 1;
        return acc;
      }, {});
      
      console.log('üìÇ Books by Category:');
      Object.entries(categories)
        .sort((a, b) => b[1] - a[1])
        .forEach(([category, count]) => {
          const bar = '‚ñà'.repeat(Math.ceil(count / 2));
          console.log(`   ${category.padEnd(20)} ${bar} ${count}`);
        });
      console.log();
    }
    
  } catch (error) {
    console.log('‚ùå Error fetching statistics:', error.message);
  }
  
  await question('Press Enter to continue...');
}

async function searchBooks() {
  clearScreen();
  showHeader();
  console.log('üîç Search Books\n');
  
  const query = await question('Enter search term (title, author, category): ');
  
  if (query.trim()) {
    console.log('\nSearching...\n');
    
    try {
      const { data: results, error } = await supabase
        .from('books')
        .select('title, author, category, average_rating, total_reviews')
        .or(`title.ilike.%${query}%,author.ilike.%${query}%,category.ilike.%${query}%`)
        .order('average_rating', { ascending: false })
        .limit(10);
      
      if (error) throw error;
      
      if (results && results.length > 0) {
        console.log(`Found ${results.length} results:\n`);
        results.forEach((book, index) => {
          console.log(`${index + 1}. "${book.title}" by ${book.author}`);
          console.log(`   Category: ${book.category} | ‚≠ê ${book.average_rating} (${book.total_reviews} reviews)`);
          console.log();
        });
      } else {
        console.log('No books found matching your search.');
      }
      
    } catch (error) {
      console.log('‚ùå Search failed:', error.message);
    }
  }
  
  await question('\nPress Enter to continue...');
}

function showGuides() {
  clearScreen();
  showHeader();
  console.log('üìñ Quick Reference Guides\n');
  console.log('Available documentation files:\n');
  console.log('1. DATABASE_README.md     - Main guide & quick start');
  console.log('2. DATABASE_GUIDE.md      - Complete documentation (600+ lines)');
  console.log('3. SQL_OPERATIONS.md      - SQL query reference (600+ lines)');
  console.log('4. DATABASE_STATUS.md     - Current status & overview');
  console.log('5. FIX_DATABASE_NOW.sql   - Permission fix script');
  console.log();
  console.log('üí° Open these files in your code editor to view detailed guides!');
  console.log();
}

async function showGuidesMenu() {
  showGuides();
  await question('Press Enter to continue...');
}

async function mainLoop() {
  let running = true;
  
  while (running) {
    clearScreen();
    showHeader();
    showMainMenu();
    
    const choice = await question('Enter your choice (0-9): ');
    
    switch (choice.trim()) {
      case '1':
        await checkHealth();
        break;
      case '2':
        await fixPermissions();
        break;
      case '3':
        await importBooks();
        break;
      case '4':
        await addReviews();
        break;
      case '5':
        await backupDatabase();
        break;
      case '6':
        await restoreDatabase();
        break;
      case '7':
        await viewStatistics();
        break;
      case '8':
        await searchBooks();
        break;
      case '9':
        await showGuidesMenu();
        break;
      case '0':
        running = false;
        clearScreen();
        showHeader();
        console.log('Thank you for using KitapKe≈üif Database Manager!');
        console.log('Your SQL Database Specialist is always ready to help! üöÄ\n');
        break;
      default:
        console.log('\n‚ùå Invalid choice. Please enter a number from 0-9.');
        await question('Press Enter to continue...');
    }
  }
  
  rl.close();
}

// Start the interactive manager
console.log('Starting Database Manager...\n');
mainLoop().catch(error => {
  console.error('Fatal error:', error);
  rl.close();
  process.exit(1);
});
